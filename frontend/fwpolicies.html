<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>BNK Firewall Policies</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: transparent;
      padding: 20px;
    }
    
    h2 {
      font-size: 2em;
      color: #1a1a1a;
      margin-bottom: 24px;
      font-weight: 700;
    }
    
    .controls {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      margin-bottom: 20px;
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .controls label {
      font-weight: 600;
      color: #555;
      font-size: 0.9em;
    }
    
    .controls select {
      padding: 10px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.95em;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }
    
    .controls select:hover {
      border-color: #a8337a;
    }
    
    .controls select:focus {
      outline: none;
      border-color: #a8337a;
      box-shadow: 0 0 0 3px rgba(168, 51, 122, 0.1);
    }
    
    .controls button {
      padding: 10px 24px;
      background: linear-gradient(135deg, #a8337a 0%, #8a2a62 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(168, 51, 122, 0.3);
    }
    
    .controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(168, 51, 122, 0.4);
    }
    
    .controls button:active {
      transform: translateY(0);
    }
    
    #exportExcel {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
      margin-left: auto;
    }
    
    #exportExcel:hover {
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
    }
    
    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    th {
      padding: 16px 12px;
      text-align: left;
      font-weight: 700;
      color: #333;
      font-size: 0.85em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      user-select: none;
      position: relative;
      transition: background 0.2s;
    }
    
    th:hover {
      background: rgba(168, 51, 122, 0.08);
    }
    
    th.sorted-asc::after {
      content: " â†‘";
      color: #a8337a;
      font-size: 1em;
    }
    
    th.sorted-desc::after {
      content: " â†“";
      color: #a8337a;
      font-size: 1em;
    }
    
    tbody tr {
      border-bottom: 1px solid #f0f0f0;
      transition: all 0.2s;
    }
    
    tbody tr:hover {
      background: linear-gradient(90deg, rgba(168, 51, 122, 0.04) 0%, transparent 100%);
    }
    
    td {
      padding: 16px 12px;
      color: #444;
      font-size: 0.95em;
    }
    
    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.85em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .badge-ingress {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);
    }
    
    .badge-egress {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
      box-shadow: 0 2px 6px rgba(255, 152, 0, 0.3);
    }
    
    .badge-unassociated {
      background: #e0e0e0;
      color: #666;
    }
    
    .action-accept {
      color: #2196F3;
      font-weight: 700;
      padding: 4px 8px;
      background: rgba(33, 150, 243, 0.1);
      border-radius: 4px;
    }
    
    .action-drop {
      color: #a8337a;
      font-weight: 700;
      padding: 4px 8px;
      background: rgba(168, 51, 122, 0.1);
      border-radius: 4px;
    }
    
    .action-reject {
      color: #FF9800;
      font-weight: 700;
      padding: 4px 8px;
      background: rgba(255, 152, 0, 0.1);
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h3>ðŸ”’ Firewall Policies</h2>

  <div class="controls">
    <label for="typeFilter">Type filter:</label>
    <select id="typeFilter">
      <option value="">All</option>
      <option value="ingress">Ingress</option>
      <option value="egress">Egress</option>
      <option value="unassociated">Unassociated</option>
    </select>

    <label for="nsFilter">Namespace filter:</label>
    <select id="nsFilter">
      <option value="">All</option>
    </select>

    <label for="refreshInterval">Refresh interval:</label>
    <select id="refreshInterval">
      <option value="5000">5 seconds</option>
      <option value="20000">20 seconds</option>
      <option value="60000">1 minute</option>
      <option value="manual">Manual</option>
    </select>

    <button id="manualRefresh">ðŸ”„ Refresh</button>
    <button id="exportExcel">ðŸ“Š Export to Excel</button>
  </div>

  <div class="table-container">
    <table id="policies-table">
      <thead>
        <tr>
          <th data-column="policyName">Policy Name</th>
          <th data-column="type">Type</th>
          <th data-column="app">Gateway/Listener or Egress</th>
          <th data-column="namespace">Namespace</th>
          <th data-column="ruleName">Rule Name</th>
          <th data-column="action">Action</th>
          <th data-column="source">SRC IP</th>
          <th data-column="sourcePorts">SRC Port</th>
          <th data-column="destination">DST IP</th>
          <th data-column="destinationPorts">DST Port</th>
          <th data-column="protocol">Protocol</th>
          <th data-column="logging">Logging</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let refreshTimer = null;
    let allPolicies = [];
    let sortColumn = 'policyName';
    let sortDirection = 'asc';

    async function loadPolicies() {
      try {
        const res = await fetch('/api/all-firewall-policies');
        const data = await res.json();
        allPolicies = data.policies || [];
        populateFilters();
        sortAndRender();
      } catch (err) {
        console.error("Error loading policies:", err);
      }
    }

    function populateFilters() {
      const nsSelect = document.getElementById("nsFilter");
      const currentNsSelection = nsSelect.value;

      const namespaces = new Set(allPolicies.map(p => p.namespace));
      nsSelect.innerHTML = '<option value="">All</option>';
      Array.from(namespaces).sort().forEach(ns => {
        const option = document.createElement('option');
        option.value = ns;
        option.textContent = ns;
        nsSelect.appendChild(option);
      });

      if (currentNsSelection && Array.from(nsSelect.options).some(o => o.value === currentNsSelection)) {
        nsSelect.value = currentNsSelection;
      }
    }

    function sortPolicies(policies) {
      return policies.sort((a, b) => {
        let aVal = a[sortColumn] || '';
        let bVal = b[sortColumn] || '';
        
        if (sortColumn === 'port') {
          aVal = aVal === '-' ? -1 : parseInt(aVal) || 0;
          bVal = bVal === '-' ? -1 : parseInt(bVal) || 0;
        }
        
        if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
        return 0;
      });
    }

    function sortAndRender() {
      updateSortIndicators();
      renderTable();
    }

    function updateSortIndicators() {
      document.querySelectorAll('th').forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
        if (th.dataset.column === sortColumn) {
          th.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
      });
    }

    function renderTable() {
      const tbody = document.querySelector('#policies-table tbody');
      tbody.innerHTML = '';

      const selectedType = document.getElementById("typeFilter").value;
      const selectedNS = document.getElementById("nsFilter").value;

      let filteredPolicies = allPolicies.filter(p => {
        if (selectedType && p.type !== selectedType) return false;
        if (selectedNS && !p.namespace.includes(selectedNS)) return false;
        return true;
      });

      filteredPolicies = sortPolicies(filteredPolicies);

      filteredPolicies.forEach((policy) => {
        if (!policy.rules || policy.rules.length === 0) {
          const tr = document.createElement('tr');
          
          const tdName = document.createElement('td');
          tdName.textContent = policy.policyName;
          tr.appendChild(tdName);
          
          const tdType = document.createElement('td');
          const badgeClass = policy.type === 'ingress' ? 'badge-ingress' : 
                            policy.type === 'egress' ? 'badge-egress' : 'badge-unassociated';
          tdType.innerHTML = `<span class="badge ${badgeClass}">${policy.type.toUpperCase()}</span>`;
          tr.appendChild(tdType);
          
          const tdApp = document.createElement('td');
          tdApp.textContent = policy.app;
          tr.appendChild(tdApp);
          
          const tdNs = document.createElement('td');
          tdNs.textContent = policy.namespace;
          tr.appendChild(tdNs);
          
          for (let i = 0; i < 8; i++) {
            const td = document.createElement('td');
            td.textContent = '-';
            tr.appendChild(td);
          }
          
          tbody.appendChild(tr);
        } else {
          policy.rules.forEach((rule, ruleIndex) => {
            const tr = document.createElement('tr');
            
            const tdName = document.createElement('td');
            tdName.textContent = policy.policyName;
            tr.appendChild(tdName);
            
            const tdType = document.createElement('td');
            const badgeClass = policy.type === 'ingress' ? 'badge-ingress' : 
                              policy.type === 'egress' ? 'badge-egress' : 'badge-unassociated';
            tdType.innerHTML = `<span class="badge ${badgeClass}">${policy.type.toUpperCase()}</span>`;
            tr.appendChild(tdType);
            
            const tdApp = document.createElement('td');
            tdApp.textContent = policy.app;
            tr.appendChild(tdApp);
            
            const tdNs = document.createElement('td');
            tdNs.textContent = policy.namespace;
            tr.appendChild(tdNs);
            
            const tdRuleName = document.createElement('td');
            tdRuleName.innerHTML = `<strong>${rule.name}</strong>`;
            tr.appendChild(tdRuleName);
            
            const tdAction = document.createElement('td');
            let actionClass = 'action-drop';
            const action = (rule.action || '').toLowerCase();
            if (action === 'accept') actionClass = 'action-accept';
            else if (action === 'reject') actionClass = 'action-reject';
            tdAction.innerHTML = `<span class="${actionClass}">${action.toUpperCase()}</span>`;
            tr.appendChild(tdAction);
            
            const tdSource = document.createElement('td');
            const srcIp = rule.source && rule.source.trim() !== '' ? rule.source.replace(/, /g, '<br>') : 'any';
            tdSource.innerHTML = srcIp;
            tr.appendChild(tdSource);
            
            const tdSourcePorts = document.createElement('td');
            const srcPorts = rule.sourcePorts && rule.sourcePorts.trim() !== '' ? rule.sourcePorts.replace(/, /g, '<br>') : 'any';
            tdSourcePorts.innerHTML = srcPorts;
            tr.appendChild(tdSourcePorts);
            
            const tdDestination = document.createElement('td');
            if (policy.type === 'ingress') {
              tdDestination.textContent = policy.gatewayIp || policy.ip || 'any';
            } else {
              const dstIp = rule.destination && rule.destination.trim() !== '' ? rule.destination.replace(/, /g, '<br>') : 'any';
              tdDestination.innerHTML = dstIp;
            }
            tr.appendChild(tdDestination);
            
            const tdDestPorts = document.createElement('td');
            if (policy.type === 'ingress') {
              tdDestPorts.textContent = policy.port || 'any';
            } else {
              const dstPorts = rule.destinationPorts && rule.destinationPorts.trim() !== '' ? rule.destinationPorts.replace(/, /g, '<br>') : 'any';
              tdDestPorts.innerHTML = dstPorts;
            }
            tr.appendChild(tdDestPorts);
            
            const tdProtocol = document.createElement('td');
            if (policy.type === 'ingress') {
              tdProtocol.textContent = (policy.protocol || '').toLowerCase();
            } else {
              tdProtocol.textContent = (rule.ipProtocol || 'any').toLowerCase();
            }
            tr.appendChild(tdProtocol);
            
            const tdLogging = document.createElement('td');
            tdLogging.textContent = (rule.logging || '').toString().toLowerCase();
            tr.appendChild(tdLogging);
            
            tbody.appendChild(tr);
          });
        }
      });
    }

    function setupAutoRefresh() {
      const intervalSelect = document.getElementById("refreshInterval");
      if (refreshTimer) clearInterval(refreshTimer);

      const value = intervalSelect.value;
      if (value !== "manual") {
        refreshTimer = setInterval(loadPolicies, parseInt(value));
      }
    }

    document.querySelectorAll('th[data-column]').forEach(th => {
      th.addEventListener('click', () => {
        const column = th.dataset.column;
        if (sortColumn === column) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortColumn = column;
          sortDirection = 'asc';
        }
        sortAndRender();
      });
    });

    document.getElementById("typeFilter").addEventListener("change", renderTable);
    document.getElementById("nsFilter").addEventListener("change", renderTable);
    document.getElementById("refreshInterval").addEventListener("change", setupAutoRefresh);
    document.getElementById("manualRefresh").addEventListener("click", loadPolicies);
    document.getElementById("exportExcel").addEventListener("click", exportToExcel);

    function exportToExcel() {
      let csvContent = "Policy Name,Type,Gateway/Listener or Egress,Namespace,Rule Name,Action,SRC IP,SRC Port,DST IP,DST Port,Protocol,Logging\n";
      
      const selectedType = document.getElementById("typeFilter").value;
      const selectedNS = document.getElementById("nsFilter").value;

      let filteredPolicies = allPolicies.filter(p => {
        if (selectedType && p.type !== selectedType) return false;
        if (selectedNS && !p.namespace.includes(selectedNS)) return false;
        return true;
      });

      filteredPolicies = sortPolicies(filteredPolicies);

      filteredPolicies.forEach(policy => {
        if (!policy.rules || policy.rules.length === 0) {
          csvContent += `"${policy.policyName}","${policy.type}","${policy.app}","${policy.namespace}","","","","","","","",""\n`;
        } else {
          policy.rules.forEach(rule => {
            const action = (rule.action || '').toLowerCase();
            const srcIp = rule.source && rule.source.trim() !== '' ? rule.source.replace(/,/g, ';') : 'any';
            const srcPorts = rule.sourcePorts && rule.sourcePorts.trim() !== '' ? rule.sourcePorts.replace(/,/g, ';') : 'any';
            
            let dstIp, dstPort, protocol;
            
            if (policy.type === 'ingress') {
              dstIp = policy.gatewayIp || policy.ip || 'any';
              dstPort = policy.port || 'any';
              protocol = (policy.protocol || '').toLowerCase();
            } else {
              dstIp = rule.destination && rule.destination.trim() !== '' ? rule.destination.replace(/,/g, ';') : 'any';
              dstPort = rule.destinationPorts && rule.destinationPorts.trim() !== '' ? rule.destinationPorts.replace(/,/g, ';') : 'any';
              protocol = (rule.ipProtocol || 'any').toLowerCase();
            }
            
            const logging = (rule.logging || '').toString().toLowerCase();
            
            csvContent += `"${policy.policyName}","${policy.type}","${policy.app}","${policy.namespace}","${rule.name}","${action}","${srcIp}","${srcPorts}","${dstIp}","${dstPort}","${protocol}","${logging}"\n`;
          });
        }
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", `firewall-policies-${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    loadPolicies();
    setupAutoRefresh();
  </script>
</body>
</html>
